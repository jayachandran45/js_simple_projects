<!DOCTYPE html>
<html>
  <head>
    <title>Webcam Recording and Canvas Example</title>
  </head>
  <body>
    <video id="record-video" width="640" height="480" autoplay></video>
    <canvas id="canvas" width="640" height="480"></canvas>
    <button id="start-recording">Start Recording</button>
    <button id="stop-recording">Stop Recording</button>
    <button id="switch-camera">Switch Camera</button>

    <script>
      const recordVideoEle = document.querySelector("#record-video");
      const canvas = document.querySelector("#canvas");
      const startRecordingButton = document.querySelector("#start-recording");
      const stopRecordingButton = document.querySelector("#stop-recording");
      const switchCameraButton = document.querySelector("#switch-camera");
      let frontStream = null;
      let mediaRecorder = null;
      let chunks = [];
      let recording = false;

      // Function to get media stream from the specified camera (front or back)
      function getCameraStream(facingMode) {
        return navigator.mediaDevices.getUserMedia({
          video: { facingMode: facingMode },
          audio: true, // You can add audio as well if required
        });
      }

      // Function to switch between front and back cameras
      function switchCamera() {
        const facingMode = frontStream ? "environment" : "user";
        getCameraStream(facingMode)
          .then((stream) => {
            if (frontStream) {
              frontStream.getTracks().forEach((track) => track.stop());
            }
            frontStream = stream;
            recordVideoEle.srcObject = frontStream;
          })
          .catch((error) => {
            console.error("Error accessing media devices:", error);
          });
      }

      // Add event listener to start/stop recording
      startRecordingButton.addEventListener("click", () => {
        if (!recording) {
          startRecording();
        }
      });

      stopRecordingButton.addEventListener("click", () => {
        if (recording) {
          stopRecording();
        }
      });

      // Add event listener to switch camera
      switchCameraButton.addEventListener("click", () => {
        switchCamera();
      });

      // Function to start recording
      function startRecording() {
        recording = true;
        chunks = [];
        // Create a new MediaRecorder with the canvas stream
        mediaRecorder = new MediaRecorder(canvas.captureStream(), {
          mimeType: "video/webm",
        });
        mediaRecorder.ondataavailable = handleDataAvailable;
        mediaRecorder.start();
        // Start drawing video frames onto the canvas
        drawFrames();
      }

      // Function to stop recording
      function stopRecording() {
        recording = false;
        mediaRecorder.stop();
      }

      // Function to handle data available from MediaRecorder
      function handleDataAvailable(event) {
        if (event.data && event.data.size > 0) {
          chunks.push(event.data);
        }
      }

      // Function to draw video frames onto the canvas
      function drawFrames() {
        if (recording) {
          const context = canvas.getContext("2d");
          context.drawImage(recordVideoEle, 0, 0, canvas.width, canvas.height);
          requestAnimationFrame(drawFrames);
        }
      }

      // Initially, get the video stream with the default facing mode (front camera)
      switchCamera();
    </script>
  </body>
</html>
